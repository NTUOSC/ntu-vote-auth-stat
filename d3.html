<!DOCTYPE html>
<html>
<head>
    <title>臺大開源社：105-2 學生會暨自治組織選舉領票統計</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta property="og:title" content="105-2 學生會暨自治組織選舉領票統計">
    <meta property="og:type" content="website">
    <meta property="og:url" content="http://vote.ntuosc.org/statistics/105-2/">
    <meta property="og:image" content="http://vote.ntuosc.org/statistics/105-2/assets/chart.png">
    <meta property="og:site_name" content="臺灣大學開源社">
    <meta property="og:description" content="開源社負責開發電子投票「嗶卡領票」的身份驗證系統，並針對這次學生代表選舉相關數據做了分析。一起來看看哪個票點最熱門、哪裡又是拓荒前線吧！">

    <link rel="shortcut icon" href="assets/favicon.png" type="image/png">
    <script src="vendor/d3.v4.min.js"></script>
    <style>
    * {
        box-sizing: border-box;
    }

    body, html {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
    }

    .chart {
        width: 90%;
        margin: auto;
    }

    svg {
        width: 100%;
        height: 100%;
    }

    </style>
</head>
<body>
    <div class="chart">
        <svg></svg>
    </div>
    <script>
        var margin = { top: 30, right: 60, bottom: 30, left: 60 };
        var width = 960, height = 540;
        var chart = d3.select("svg")
                        .attr("preserveAspectRatio", "xMidYMid meet")
                        .attr("viewBox", "0 0 "+width+" "+height)
                        .append("g")
                        .attr("transform", "translate("+margin.left+","+margin.top+")");

        width -= margin.left + margin.right;
        height -= margin.top + margin.bottom;

        var x = d3.scaleTime().range([0, width]);
        var y = d3.scaleLinear().range([height, 0]);
        var color = {
            centered: function(i) {
                var rel = (i - (series.length / 2));
                var pos = ((rel > 0 ? 0 : 1) + Math.abs(rel) * 2) / (series.length + 1);
                return d3.interpolatePlasma(1 - pos);
            },
            stacked: function(i) {
                return d3.interpolatePlasma(1 - i / (series.length - 1));
            }
        };
        var area = d3.area()
                    .x(function(d) { return x(d.data.time); })
                    .y0(function(d) { return y(d[0]); })
                    .y1(function(d) { return y(d[1]); })
                    .curve(d3.curveMonotoneX);
        var stack = d3.stack();
        var graph = chart.append("g")
                        .attr("class", "graph")
                        .attr("transform", "translate(0,"+(-height/2)+")");

        var parseTime = d3.timeParse("%H:%M");
        var formatTime = d3.timeFormat("%I:%M%p");

        var entries, series, seriesNames;
        var table = d3.map();

        var duration = 120, uiDuration = 70;

        var xAxis = d3.axisBottom().scale(x);
        var yAxis = d3.axisLeft().scale(y);

        var timeRange = {
            starting: { hour: 9, minute: 30 },
            ending: { hour: 20, minute: 0 }
        }

        for (var h = timeRange.starting.hour, m = timeRange.starting.minute;
            h < timeRange.ending.hour || m <= timeRange.ending.minute;
            (m >= 45 ? (m = 0, h++) : m += 15))
            {
                t = (h < 10 ? "0" : "") + h + ":" + (m < 10 ? "00" : m);
                table.set(t, { time: parseTime(t), sum: 0 });
            }

        d3.csv("data/105-2/station-time.csv", function(data) {
            entries = data;
            series = d3.nest()
                        .key(function(d) { return d.station; })
                        .map(entries).keys();

            d3.nest()
                .key(function(d) { return d.time; })
                .entries(entries)
                .forEach(function(t) {
                    i = table.get(t.key);
                    t.values.forEach(function(e) {
                        i[e.station] = +e.count;
                        i.sum += +e.count;
                    });
                    table.set(t.key, i);
                });

            table = table.values();

            x.domain(d3.extent(table, function(d) { return d.time; }));
            y.domain([0, d3.max(table, function(d) { return d.sum; })]);

            stack.keys(series)
                .value(function(d, key) { return d[key] || 0; })
                .order(d3.stackOrderInsideOut)
                .offset(d3.stackOffsetSilhouette);

            graph.selectAll(".series")
                .data(stack(table))
                .enter()
                .append("g")
                .attr("class", "series")
                .append("path")
                .attr("class", "area")
                .attr("opacity", 1)
                .on("mouseover", function(d, i) {
                    graph.selectAll(".series")
                        .transition().duration(uiDuration)
                        .attr("opacity", function(d, j) {
                            return (j != i) ? 0.9 : 1;
                        });
                    d3.select(this)
                        .attr("stroke", "rgba(0,0,0,.33)")
                        .attr("stroke-width", "1px");
                })
                .on("mousemove", function(d, i) {
                    var mousex = d3.mouse(this)[0];
                    var invertedx = x.invert(mousex);
                    for (var j in table) {
                        item = table[j];
                        if (item.time >= invertedx) {
                            d3.select(".tooltip")
                                .text(d.key + " " + formatTime(item.time) + " " + (item[d.key] || 0));
                            break;
                        }
                    }
                })
                .on("mouseout", function(d, i) {
                    graph.selectAll(".series")
                        .transition().duration(uiDuration)
                        .attr("opacity", 1);

                    d3.select(this)
                        .attr("stroke-width", "0px");

                    d3.select(".tooltip").text("");
                });

            chart.append("g")
                .attr("transform", "translate(20,20)")
                .append("text")
                .attr("class", "tooltip");

            chart.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0,"+height+")")
                .call(xAxis);

            chart.append("g")
                .attr("class", "y axis")
                .call(yAxis);

            streamgraph();
            duration = 420;
        });

        function streamgraph() {
            stack.order(d3.stackOrderInsideOut)
                .offset(d3.stackOffsetSilhouette);

            graph.transition().duration(duration)
                .attr("transform", "translate(0,"+(-height/2)+")");

            graph.selectAll(".series")
                .data(stack(table))
                .transition().duration(duration)
                .ease(d3.easeCubic)
                .select(".area")
                .attr("d", area)
                .style("fill", function(d) { return color.centered(d.index); })

            setTimeout(stackedArea, 10000);
        }

        function stackedArea() {
            stack.order(d3.stackOrderDescending)
                .offset(d3.stackOffsetNone);

            graph.transition().duration(duration)
                .attr("transform", "translate(0,0)");

            graph.selectAll(".series")
                .data(stack(table))
                .transition().duration(duration)
                .ease(d3.easeCubic)
                .select(".area")
                .attr("d", area)
                .style("fill", function(d) { return color.stacked(d.index); })

            setTimeout(streamgraph, 10000);
        }
    </script>
    <!-- (C) RSChiang / NTUOSC 2014. https://ntuosc.org -->
</body>
</html>
